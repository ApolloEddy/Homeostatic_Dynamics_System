**[返回目录](../INDEX.md)** | **[返回本章](./README.md)** | **[上一节](./04.md)** | **[下一节](./06.md)**

# 02.5 接口化设计
### 5.1 模块职责

HDS 作为独立的核心接口模块，负责：

- 管理状态（H、N、慢变量）
- 事件感知与刺激归一化
- 产出行为向量 B
- 编译控制输出（prompt 注入片段、检索权重、采样参数建议）
- 写日志与离线巩固入口

### 5.2 对外 API

```dart
// Tick: 时间推进（可按秒或按回合）
void tick(Duration dt)

// Observe: 观测到一次事件（用户输入、系统事件、工具结果）
void observe(HDSEvent event)

// Compile: 生成本回合的控制输出（给上层 LLM/Agent 使用）
ControlBundle compile()

// Log: 写入一条交互日志（也可由 compile 自动生成）
void log(InteractionLog entry)

// Consolidate: 离线巩固（可在闲置时调用）
Future<void> consolidate({DateTime? since, DateTime? until})
```

### 5.3 ControlBundle 输出结构

```json
{
  "promptInjection": "<hds_state>...</hds_state>",
  "sampling": {
    "temperature": "<T>",
    "topP": "<P>",
    "maxTokens": "<M>"
  },
  "retrievalBias": {
    "factMemory": "<w_fact>",
    "relationMemory": "<w_relation>",
    "affectMemory": "<w_affect>",
    "styleMemory": "<w_style>"
  },
  "behavior": {
    "initiative": "<b_initiative>",
    "warmth": "<b_warmth>",
    "patience": "<b_patience>",
    "verbosity": "<b_verbosity>",
    "directness": "<b_directness>",
    "defensiveness": "<b_defensiveness>",
    "boundaryStrength": "<b_boundary>"
  },
  "styleGuidance": "concise, assertive, fewer questions",
  "debug": {
    "stateSnapshot": {
      "hSocial": "<H_social>",
      "hEnergy": "<H_energy>",
      "da": "<N_DA>",
      "ne": "<N_NE>",
      "ht": "<N_5HT>"
    },
    "reasons": ["low_energy", "high_stress"]
  }
}
```

**参数解释**：
- `<T>/<P>/<M>`：采样控制量（分别对应 \(T_t,P_t,M_t\)，均为有界变量）
- `<w_fact>/<w_relation>/<w_affect>/<w_style>`：检索偏置权重（有界；不改变事实内容）
- `<b_*>`：行为向量分量（对应 \(\mathbf{b}_t\) 的各维度）
- `<H_social>/<H_energy>/<N_DA>/<N_NE>/<N_5HT>`：状态快照（稳态 + 神经调制）

> [!NOTE]
> 如需查看符号与约束的统一定义，见 `docs/appendix/parameter-symbols.md`。

---

**[返回目录](../INDEX.md)** | **[返回本章](./README.md)** | **[上一节](./04.md)** | **[下一节](./06.md)**
