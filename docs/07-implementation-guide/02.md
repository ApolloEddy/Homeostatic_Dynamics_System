**[返回目录](../INDEX.md)** | **[返回本章](./README.md)** | **[上一节](./01.md)** | **[下一节](./03.md)**

# 07.2 API 接口设计
### 2.1 HDSService 接口

#### 2.1.1 初始化流程

HDS 服务初始化流程包括以下步骤：

1. 加载配置文件（HDSConfig）
2. 创建内驱力引擎（HomeostaticEngine）
3. 创建神经递质系统（NeuromodulatorSystem）
4. 创建刺激归一化器（StimulusNormalizer）
5. 应用自上次 tick 以来的衰减
6. 返回初始化的服务实例

#### 2.1.2 时间步进

时间步进（tick）操作：

- 调用内驱力引擎的 tick 方法，传入时间间隔
- 调用神经递质系统的 tick 方法，传入秒数
- 记录调试信息（当前 H_social 和 H_energy 值）

#### 2.1.3 事件观测

事件观测（observe）操作：

1. 使用刺激归一化器将事件转换为刺激输入
2. 将刺激注入到神经递质系统（DA、NE、5HT）
3. 根据刺激质量更新内驱力系统
4. 如果是用户消息，消耗认知能量
5. 记录调试信息

#### 2.1.4 编译控制输出

编译控制输出（compile）操作：

1. 根据当前状态计算行为向量
2. 根据行为向量和神经递质状态计算采样参数
3. 根据多巴胺状态计算检索偏置
4. 生成风格描述
5. 组装控制输出包

#### 2.1.5 离线巩固

离线巩固（consolidate）操作：

- 触发记忆服务的巩固流程
- 记录调试信息

### 2.2 ControlBundle 接口

#### 2.2.1 控制输出包

控制输出包包含以下字段：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `promptInjection` | String | 动态系统指令注入 |
| `sampling` | Object | 采样参数 |
| `sampling.temperature` | Number | 温度参数 |
| `sampling.topP` | Number | Top-P 参数 |
| `sampling.maxTokens` | Number | 最大 Token 数 |
| `retrievalBias` | Object | 检索偏置权重 |
| `retrievalBias.factMemory` | Number | 事实记忆偏置 |
| `retrievalBias.relationMemory` | Number | 关系记忆偏置 |
| `retrievalBias.affectMemory` | Number | 情绪记忆偏置 |
| `retrievalBias.styleMemory` | Number | 风格记忆偏置 |
| `behavior` | Object | 行为向量 |
| `styleGuidance` | String | 风格描述 |
| `debug` | Object | 调试信息 |
| `debug.stateSnapshot` | Object | 状态快照 |
| `debug.reasons` | Array | 决策理由 |

---

**[返回目录](../INDEX.md)** | **[返回本章](./README.md)** | **[上一节](./01.md)** | **[下一节](./03.md)**
