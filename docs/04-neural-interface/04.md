**[返回目录](../INDEX.md)** | **[返回本章](./README.md)** | **[上一节](./03.md)** | **[下一节](./05.md)**

# 04.4 检索与注意力偏置
### 4.1 设计原理

检索与注意力偏置（Cognitive Filter）是安全版本的记忆检索机制。它通过调整检索权重，实现状态感知的记忆检索，避免"低 DA 忽略正面互动"导致关系崩坏。

### 4.2 记忆分类

HDS 将记忆分为四类：

| 类别 | 名称 | 描述 | 偏置策略 |
| :--- | :--- | :--- | :--- |
| **FactMemory** | 事实记忆 | 客观事实（可验证、低情绪） | 不偏置 |
| **RelationMemory** | 关系记忆 | 偏好、边界、承诺、禁忌 | 轻微偏置（$\pm w_{relation\_bias}$） |
| **AffectMemory** | 情绪记忆 | 触发器、情绪图谱、当时状态 | 可偏置（用于氛围一致性） |
| **StyleMemory** | 风格记忆 | 在某类状态下的表达模板/语气策略 | 可偏置（用于 few-shot） |

**参数解释**：
- $w_{relation\_bias}$：关系记忆偏置范围（不展示真实数值）

### 4.3 检索偏置计算

#### 4.3.1 基础检索分数

基础检索分数：

$$
score_{base} = sim \cdot w_{category}
$$

其中：
- $sim$：余弦相似度
- $w_{category}$：类别权重

#### 4.3.2 状态匹配分数

状态匹配分数：

$$
score_{state} = w_{state\_bias} \cdot (1 + e^{-age/h_{half\_life}} + |RPE| \cdot w_{rpe})
$$

其中：
- $age$：记忆年龄
- $h_{half\_life}$：半衰期
- $RPE$：奖赏预测误差
- $w_{state\_bias}$：状态偏置权重（不展示真实数值）
- $w_{rpe}$：RPE 权重（不展示真实数值）

**参数解释**：
- $h_{half\_life}$：记忆半衰期，控制记忆衰减速度
- $w_{state\_bias}$：状态偏置权重，控制状态对检索的影响
- $w_{rpe}$：RPE 权重，控制 RPE 对检索的影响

#### 4.3.3 最终检索分数

最终检索分数：

$$
score = score_{base} + score_{state}
$$

### 4.4 偏置权重范围

#### 4.4.1 事实记忆偏置

事实记忆不偏置：

$$
w_{fact} = w_{fact\_default}
$$

**参数解释**：
- $w_{fact\_default}$：事实记忆默认权重

#### 4.4.2 关系记忆偏置

关系记忆轻微偏置：

$$
w_{relation} = \text{clamp}(w_{relation\_base} + (N_{\mathrm{DA}} - w_{DA\_midpoint}) \cdot w_{relation\_bias}, w_{relation\_base} - w_{relation\_bias}, w_{relation\_base} + w_{relation\_bias})
$$

**参数解释**：
- $w_{DA\_midpoint}$：多巴胺中点值
- $w_{relation\_base}$：关系记忆基础权重
- $w_{relation\_bias}$：关系记忆偏置范围

#### 4.4.3 情绪记忆偏置

情绪记忆可偏置：

$$
w_{affect} = \text{clamp}(w_{affect\_base} + (N_{\mathrm{DA}} - w_{DA\_midpoint}) \cdot w_{affect\_bias}, w_{affect\_base} - w_{affect\_bias}, w_{affect\_base} + w_{affect\_bias})
$$

其中：
- $w_{DA\_midpoint}$：多巴胺中点值
- $w_{affect\_base}$：情绪记忆基础权重
- $w_{affect\_bias}$：情绪记忆偏置范围（不展示真实数值）

**参数解释**：
- $w_{DA\_midpoint}$：多巴胺中点值
- $w_{affect\_base}$：情绪记忆基础权重
- $w_{affect\_bias}$：情绪记忆偏置范围，控制情绪记忆的偏置程度

#### 4.4.4 风格记忆偏置

风格记忆可偏置：

$$
w_{style} = \text{clamp}(w_{style\_base} + (N_{\mathrm{DA}} - w_{DA\_midpoint}) \cdot w_{style\_bias}, w_{style\_base} - w_{style\_bias}, w_{style\_base} + w_{style\_bias})
$$

**参数解释**：
- $w_{DA\_midpoint}$：多巴胺中点值
- $w_{style\_base}$：风格记忆基础权重
- $w_{style\_bias}$：风格记忆偏置范围

其中：
- $w_{style\_bias}$：风格记忆偏置范围（不展示真实数值）

**参数解释**：
- $w_{style\_bias}$：风格记忆偏置范围，控制风格记忆的偏置程度

---

**[返回目录](../INDEX.md)** | **[返回本章](./README.md)** | **[上一节](./03.md)** | **[下一节](./05.md)**
